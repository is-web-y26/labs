# ЛР 1. Деплой на Render и шаблонизация страниц приложения

Целью данной лабораторной работы является включение имеющейся клиентской части (лабораторных работ прошлого семестра) внутрь нового приложения, которое будет развернуто в сервисе облачного хостинга Render, и получение навыков работы с шаблонизаторами пользовательских представлений.

## Деплой приложения на Render

Для выполнения этой части лабораторной работы вам необходимо:

1. Установить NodeJS [глобально](https://nodejs.org/en/download/) или [через утилиту `nvm`](https://github.com/nvm-sh/nvm) (рекомендуется последняя LTS-версия, т.е. 22);
2. [Установить пакет NestJS CLI](https://docs.nestjs.com/cli/overview#installation) глобально через пакетный менеджер NPM;
3. Зарегистрироваться в хостинг-сервисе [Render](https://dashboard.render.com/register);

Чтобы создать приложение NestJS с помощью Nest CLI, необходимо выполнить команду `nest new` в терминале вашей операционной системы. Укажите имя проекта и выберите пакетный менеджер, которым вы пользуетесь (по умолчанию npm). В результате будет сгенерирован проект в новой директории с именем вашего проекта.

Откройте проект в IDE и ознакомьтесь с файлом `package.json` и его структурой. Отредактируйте поле `author` согласно [схеме](https://docs.npmjs.com/cli/v7/configuring-npm/package-json#people-fields-author-contributors), укажите ваше авторство. Добавьте явное указание используемой версии NodeJS согласно [схеме](https://docs.npmjs.com/cli/v9/configuring-npm/package-json#engines), без этого сборка вашего приложения на сервисе Render упадет с ошибкой.

Проверьте, что ваше приложение работает, для этого выполните скрипт запуска, описанный в `package.json` (`npm run start` в случае, если вы пользуетесь пакетным менеджером по умолчанию). В дальнейшем для локальной разработки рекомендуется использовать команду `npm run start:dev` для автоматического применения изменений.

Обратите внимание, что запущенное приложение запускается на 3000-ом порту: http://localhost:3000. Для хостинга Render такое поведение приемлемо, т.к. Render автоматически найдёт открываемый вами порт, но в общепринятой практике обычно хостинг сам сообщает вам через переменную окружения с именем `PORT` номер порта, на котором необходимо принимать соединения. Биндинг вашего приложения на 3000-ый порт осуществляется в файле `src/main.ts`. Отредактируйте файл таким образом, чтобы приложение начинало слушать подключения на порту, указанному в переменной окружения, а в случаях, когда порт не указан, брать порт по умолчанию (на ваш выбор).

Переменные окружения хоста могут быть прочитаны двумя способами:

1. Напрямую средствами NodeJS через [process.env](https://nodejs.org/dist/latest-v8.x/docs/api/process.html#process_process_env);
2. С помощью [модуля конфигурации Nest](https://docs.nestjs.com/techniques/configuration) (предпочтительно).

После добавления необходимой обработки проверьте, что приложение стартует на указанном в переменной окружения порту, для этого необходимо настроить профиль запуска ([пример для WebStorm](https://i.imgur.com/jCWYqeM.png)).

Если всё получилось, то можно переходить к следующему шагу — созданию самого инстанса приложения на хостинге. Для этого необходимо загрузить сгенерированное с помощью Nest CLI шаблонное приложение в репозиторий GitHub. Обратите внимание, что в отличие от прошлого семестра, **приватный (!)** репозиторий необходимо создать в организации `is-web-y26` либо перенести туда уже существующий.

### Как попасть в организацию?

Для этого необходимо [заполнить форму](https://forms.gle/3ACANEEtPMeTGqir5), это нужно, чтобы преподаватели могли отслеживать ваш прогресс в течение семестра. После заполнения формы через некоторое время придёт приглашение в организацию.

Когда вы загрузите код приложения в репозиторий, необходимо его будет подключить к хостингу Render. Для этого выбирайте в меню **New → Web Service**.

![](https://i.imgur.com/lrRooXw.png)

В организации уже настроена интеграция с хостинг-сервисом, поэтому дополнительно вам ничего подключать не нужно, просто выбирайте ваш репозиторий и переходите на следующий шаг.

![](https://i.imgur.com/ykPy0Bm.png)

* Имя сервиса: то, что вы указывали в форме, когда добавлялись в организацию;
* Регион: на ваш выбор, рекомендум ближайшую геопозицию (Europe, Frankfurt);
* Ветка: в зависимости от того как привыкли, `main` либо `master` (либо `development` если планируется GitFlow и более чем одна версия среды);
* Корневая директория: директория, в которой находится ваш проект, если не меняли файловую структуру, то оставьте поле пустым;
* Окружение: Node;
* Команда для сборки: необходимо восстановить зависимости и вызвать скрипт `build` с помощью выбранного вами пакетного менеджера:
   * Для `npm`: `npm install; npm run build`
   * Для `yarn`: `yarn; yarn build`

В качестве входной точки рекомендуется использовать production-версию вашего приложения, т.е. команду `npm run start:prod` для npm либо команду `yarn start:prod` для yarn соответственно.

После того, как вы создадите веб сервис на хостинге, должен [начаться автоматический процесс сборки](https://youtu.be/39ngI2PF43Q?t=809) с отображением прогресса.

Если все прошло без ошибок, то ваше приложение должно быть доступно в сети Интернет по ссылке, предоставленной на хостинге.

Если при переходе на страницу вы видите Hello World, то всё отлично, осталось только разместить статические ресурсы (на данный момент статикой будет являться весь фронтенд, который был разработан в рамках лабораторных работ прошлого семестра) и научиться отдавать их с сервера. Для этого необходимо воспользоваться [следующим рецептом](https://docs.nestjs.com/techniques/mvc).

Укажем в момент запуска нашего Nest-приложения, что мы хотим воспользоваться шаблоном MVC, основанном на фреймворке [Express](https://expressjs.com/ru/). Укажем, что хотим иметь возможность отдавать статические ресурсы, расположенные в конкретной папке (по умолчанию `public`). Затем необходимо будет перенести все ваши файлы с frontend’ом в указанную папку и проверить, что статика отдаётся, т.е. сделать запрос на http://localhost:port/index.html.

Если всё хорошо, измените стандартный файл `README.md` и добавьте краткое описание вашего проекта, укажите ваше авторство и **обязательно** дайте ссылку на развёрнутое приложение.

Далее делаем коммит и пушим результат.

Процесс доставки изменений (Continuous Delivery) на хостинг должен начаться автоматически, точно так же, как это происходило при использовании GitHub Pages.

## Шаблонизация страниц

После успешного развёртывания приложения нужно подключить шаблонизатор ([любой из списка](https://expressjs.com/en/resources/template-engines.html)) и выделить повторяющиеся блоки в отдельные представления в вашем проекте.

Чтобы зарегистрировать выбранный вами шаблонизатор в приложение NestJS, необходимо выполнить его явно определить при инициализации приложения согласно [инструкции в документации](https://docs.nestjs.com/techniques/mvc#model-view-controller).

Части (partials) веб-страниц, обязательных к выделению в отдельные представления:

* Shared Script / Style bundles (общие стили и скрипты используемые на всех страницах повсеместно);
* Header (Заголовок);
* Пункты меню;
* Информация о сессии (Вы вошли как … / Кнопка регистрация и т.д.);
* Content (Контейнер под основное содержание страницы);
* Footer (Подвал);
* Блоки, повторяющиеся на одной странице (например, карточки товаров).

Поскольку сейчас в приложении нет маршрутов и контроллеров для ваших страниц, необходимо будет их добавить для обеспечения возможности рендеринга ваших представлений, например:

```ts
@Controller()
export class AppController {
    @Get()
    @Render('index') // <= Название вашего представления
    getIndexPage() {
        return { user: 'Hello world!' }; // Модель представления
    }
}
```

Информацию для отрисовки блоков типа карточек товаров пока что можно передавать просто объектом, как в примере выше, в следующих лабораторных это будет доработано.

Подготовьте как минимум два состояния для представления информации о текущей сессии пользователя (Авторизован и неавторизован). Переключаться между представлениями можно, например, с помощью [параметров запроса](https://docs.nestjs.com/controllers#query-parameters) (но необязательно именно так).

![](https://i.imgur.com/Dp9rv3C.png)
